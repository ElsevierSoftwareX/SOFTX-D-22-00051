# import numpy as np
import pytest

r"""
Hyperlinks to drtsans functions
namedtuplefy <https://code.ornl.gov/sns-hfir-scse/sans/sans-backend/blob/next/drtsans/settings.py>
IQmod, testing <https://code.ornl.gov/sns-hfir-scse/sans/sans-backend/blob/next/drtsans/dataobjects.py>
stitch_profiles <https://code.ornl.gov/sns-hfir-scse/sans/sans-backend/blob/next/drtsans/stitch.py>
"""
from drtsans.settings import namedtuplefy
from drtsans.dataobjects import IQmod, testing
from drtsans.stitch import stitch_profiles


@pytest.fixture(scope="module")
@namedtuplefy
def data_test_16b():
    r"""
    Stitch three intensity profiles. Data obtained from:
    - <https://www.dropbox.com/s/eehgqwmi3ap9dtj/data_stitching_test.pdf>
    - <https://www.dropbox.com/s/8yxa52vuy4ojrwz/data_stitching_test.xlsx>

    IQmod profiles are generated by passing, in this order, the following quantities: (i) intensities; (ii) errors in
    intensities; (iii) Q values, (iv) errors in Q values
    """
    return dict(
        profiles=[
            IQmod(
                [
                    3.1622777e01,
                    2.7950850e00,
                    6.7620100e-01,
                    2.4705300e-01,
                    1.1313700e-01,
                    5.9768000e-02,
                    3.4846000e-02,
                    2.1837000e-02,
                    1.4459000e-02,
                    1.0000000e-02,
                    7.1640000e-03,
                    5.2830000e-03,
                    3.9920000e-03,
                    3.0800000e-03,
                    2.4190000e-03,
                ],
                [
                    3.16228e-01,
                    2.79510e-02,
                    6.76200e-03,
                    2.47100e-03,
                    1.13100e-03,
                    5.98000e-04,
                    3.48000e-04,
                    2.18000e-04,
                    1.45000e-04,
                    1.00000e-04,
                    7.20000e-05,
                    5.30000e-05,
                    4.00000e-05,
                    3.10000e-05,
                    2.40000e-05,
                ],
                [
                    0.001,
                    0.002,
                    0.003,
                    0.004,
                    0.005,
                    0.006,
                    0.007,
                    0.008,
                    0.009,
                    0.01,
                    0.011,
                    0.012,
                    0.013,
                    0.014,
                    0.015,
                ],
                [
                    1.0e-05,
                    2.0e-05,
                    3.0e-05,
                    4.0e-05,
                    5.0e-05,
                    6.0e-05,
                    7.0e-05,
                    8.0e-05,
                    9.0e-05,
                    1.0e-04,
                    1.1e-04,
                    1.2e-04,
                    1.3e-04,
                    1.4e-04,
                    1.5e-04,
                ],
            ),
            IQmod(
                [
                    1.073269,
                    0.651967,
                    0.421468,
                    0.285972,
                    0.201697,
                    0.146838,
                    0.109761,
                    0.0839,
                    0.065374,
                    0.051791,
                    0.041631,
                    0.033897,
                    0.027915,
                    0.023225,
                    0.019502,
                ],
                [
                    0.010733,
                    0.00652,
                    0.004215,
                    0.00286,
                    0.002017,
                    0.001468,
                    0.001098,
                    0.000839,
                    0.000654,
                    0.000518,
                    0.000416,
                    0.000339,
                    0.000279,
                    0.000232,
                    0.000195,
                ],
                [
                    0.0098,
                    0.0113,
                    0.0128,
                    0.0143,
                    0.0158,
                    0.0173,
                    0.0188,
                    0.0203,
                    0.0218,
                    0.0233,
                    0.0248,
                    0.0263,
                    0.0278,
                    0.0293,
                    0.0308,
                ],
                [
                    9.80e-05,
                    1.13e-04,
                    1.28e-04,
                    1.43e-04,
                    1.58e-04,
                    1.73e-04,
                    1.88e-04,
                    2.03e-04,
                    2.18e-04,
                    2.33e-04,
                    2.48e-04,
                    2.63e-04,
                    2.78e-04,
                    2.93e-04,
                    3.08e-04,
                ],
            ),
            IQmod(
                [
                    4.601934,
                    3.481434,
                    2.68861,
                    2.113573,
                    1.687456,
                    1.365714,
                    1.118729,
                    0.926323,
                    0.774452,
                    0.65315,
                    0.55522,
                    0.475386,
                    0.409725,
                    0.355278,
                    0.30979,
                ],
                [
                    0.046019,
                    0.034814,
                    0.026886,
                    0.021136,
                    0.016875,
                    0.013657,
                    0.011187,
                    0.009263,
                    0.007745,
                    0.006531,
                    0.005552,
                    0.004754,
                    0.004097,
                    0.003553,
                    0.003098,
                ],
                [
                    0.0241,
                    0.0261,
                    0.0281,
                    0.0301,
                    0.0321,
                    0.0341,
                    0.0361,
                    0.0381,
                    0.0401,
                    0.0421,
                    0.0441,
                    0.0461,
                    0.0481,
                    0.0501,
                    0.0521,
                ],
                [
                    0.000241,
                    0.000261,
                    0.000281,
                    0.000301,
                    0.000321,
                    0.000341,
                    0.000361,
                    0.000381,
                    0.000401,
                    0.000421,
                    0.000441,
                    0.000461,
                    0.000481,
                    0.000501,
                    0.000521,
                ],
            ),
        ],
        target_index=0,  # profile of the previous list of IQmod objets defining the overall scale.
        overlaps=[
            0.01,
            0.014,
            0.025,
            0.029,
        ],  # [(start, end), (start, end)] overlap regions
        stitched=IQmod(
            [
                3.16227766e01,
                2.79508497e00,
                6.76200688e-01,
                2.47052942e-01,
                1.13137085e-01,
                5.97682620e-02,
                3.48463150e-02,
                2.18366010e-02,
                1.44594310e-02,
                1.00000000e-02,
                7.16350600e-03,
                6.36406900e-03,
                5.28281800e-03,
                4.11409700e-03,
                3.99207100e-03,
                2.79147200e-03,
                1.96883600e-03,
                1.43333600e-03,
                1.07141300e-03,
                8.18980000e-04,
                6.38134000e-04,
                5.05550000e-04,
                4.06376000e-04,
                3.40064000e-04,
                3.30875000e-04,
                2.72491000e-04,
                2.62621000e-04,
                2.06452000e-04,
                1.64829000e-04,
                1.33402000e-04,
                1.09277000e-04,
                9.04830000e-05,
                7.56480000e-05,
                6.37990000e-05,
                5.42330000e-05,
                4.64350000e-05,
                4.00220000e-05,
                3.47030000e-05,
                3.02600000e-05,
            ],
            [
                3.16227766e-01,
                2.79508500e-02,
                6.76200700e-03,
                2.47052900e-03,
                1.13137100e-03,
                5.97683000e-04,
                3.48463000e-04,
                2.18366000e-04,
                1.44594000e-04,
                1.00000000e-04,
                7.16350000e-05,
                6.36410000e-05,
                5.28280000e-05,
                4.11410000e-05,
                3.99210000e-05,
                2.79150000e-05,
                1.96880000e-05,
                1.43330000e-05,
                1.07140000e-05,
                8.19000000e-06,
                6.38100000e-06,
                5.05500000e-06,
                4.06400000e-06,
                3.40100000e-06,
                3.30900000e-06,
                2.72500000e-06,
                2.62600000e-06,
                2.06500000e-06,
                1.64800000e-06,
                1.33400000e-06,
                1.09300000e-06,
                9.05000000e-07,
                7.56000000e-07,
                6.38000000e-07,
                5.42000000e-07,
                4.64000000e-07,
                4.00000000e-07,
                3.47000000e-07,
                3.03000000e-07,
            ],
            [
                0.001,
                0.002,
                0.003,
                0.004,
                0.005,
                0.006,
                0.007,
                0.008,
                0.009,
                0.01,
                0.011,
                0.0113,
                0.012,
                0.0128,
                0.013,
                0.0143,
                0.0158,
                0.0173,
                0.0188,
                0.0203,
                0.0218,
                0.0233,
                0.0248,
                0.0261,
                0.0263,
                0.0278,
                0.0281,
                0.0301,
                0.0321,
                0.0341,
                0.0361,
                0.0381,
                0.0401,
                0.0421,
                0.0441,
                0.0461,
                0.0481,
                0.0501,
                0.0521,
            ],
            [
                1.00e-05,
                2.00e-05,
                3.00e-05,
                4.00e-05,
                5.00e-05,
                6.00e-05,
                7.00e-05,
                8.00e-05,
                9.00e-05,
                1.00e-04,
                1.10e-04,
                1.13e-04,
                1.20e-04,
                1.28e-04,
                1.30e-04,
                1.43e-04,
                1.58e-04,
                1.73e-04,
                1.88e-04,
                2.03e-04,
                2.18e-04,
                2.33e-04,
                2.48e-04,
                2.61e-04,
                2.63e-04,
                2.78e-04,
                2.81e-04,
                3.01e-04,
                3.21e-04,
                3.41e-04,
                3.61e-04,
                3.81e-04,
                4.01e-04,
                4.21e-04,
                4.41e-04,
                4.61e-04,
                4.81e-04,
                5.01e-04,
                5.21e-04,
            ],
        ),
        tolerance=0.01,  # tolerate differences up to 1%
    )


def test_stitch(data_test_16b):
    r"""
    Test the stitching algorithm ~drtsans.stitch.stitch_profiles.

    **drtsans functions used:**
    ~drtsans.stitch.stitch_profiles
    <https://code.ornl.gov/sns-hfir-scse/sans/sans-backend/blob/next/drtsans/stitch.py>

    devs - Jose Borreguero <borreguerojm@ornl.gov>
    SME - Wei-Ren Chen <chenw@ornl.gov>, LiLin He <hel3@ornl.gov>
    """
    data = data_test_16b  # handy shortcut
    # call the drtsans function
    result = stitch_profiles(
        data.profiles, data.overlaps, target_profile_index=data.target_index
    )
    # Check for differences between "result" and "data.stitched" profiles. We check for differences in:
    # - intensities
    # - uncertainties in intensities
    # - Q values
    # - uncertainties in Q values
    # We tolerate differences up to 1% of the stitched profile given in the test data
    testing.assert_allclose(result, data.stitched, rtol=data.tolerance, atol=0)


if __name__ == "__main__":
    pytest.main([__file__])
